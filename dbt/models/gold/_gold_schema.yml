version: 2

models:
  - name: new_contracts
    description: New contract records with full demographics and geolocation
    config:
      schema: gold
    columns:
      - name: contract_id
        description: Contract ID
        tests:
          - unique
          - not_null
      - name: asset_id_hj
        description: Property ID
        tests:
          - not_null
      - name: contract_date
        description: Contract signing date
        tests:
          - not_null
      - name: latitude
        description: Property latitude
        tests:
          - not_null
      - name: longitude
        description: Property longitude
        tests:
          - not_null
  
  - name: moveouts
    description: Completed moveout records with full contract history
    config:
      schema: gold
    columns:
      - name: contract_id
        description: Contract ID
        tests:
          - unique
          - not_null
      - name: asset_id_hj
        description: Property ID
        tests:
          - not_null
      - name: moveout_date
        description: Moveout date
        tests:
          - not_null
      - name: latitude
        description: Property latitude
        tests:
          - not_null
      - name: longitude
        description: Property longitude
        tests:
          - not_null
  
  - name: moveout_notices
    description: Moveout notices with 24-month rolling window
    config:
      schema: gold
    columns:
      - name: contract_id
        description: Contract ID
        tests:
          - unique
          - not_null
      - name: asset_id_hj
        description: Property ID
        tests:
          - not_null
      - name: notice_received_date
        description: Date moveout notice was received
        tests:
          - not_null
  
  - name: moveout_analysis
    description: |
      Enhanced moveout analysis table with categorical dimensions for demographic and financial analysis.
      Includes rent range bucketing, age groups, tenure categories, and all demographic markers.
      Optimized for drill-down analysis and filtering by multiple dimensions.
    config:
      schema: gold
    columns:
      - name: contract_id
        description: Contract ID
        tests:
          - unique
          - not_null
      - name: asset_id_hj
        description: Property ID (AssetID_HJ)
        tests:
          - not_null
      - name: moveout_date
        description: Moveout date (退去日)
        tests:
          - not_null
      - name: rent_range
        description: Categorical rent range bucket
        tests:
          - not_null
          - accepted_values:
              values: ['Under 50K', '50K-70K', '70K-100K', '100K-150K', '150K+']
      - name: rent_range_order
        description: Sort order for rent ranges (1-5)
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5]
      - name: monthly_rent
        description: Monthly rent amount (月額賃料)
        tests:
          - not_null
      - name: prefecture
        description: Prefecture (都道府県)
      - name: municipality
        description: Municipality (市区町村)
      - name: latitude
        description: Property latitude
        tests:
          - not_null
      - name: longitude
        description: Property longitude
        tests:
          - not_null
      - name: tenant_type
        description: Tenant classification (individual/corporate)
        tests:
          - not_null
          - accepted_values:
              values: ['individual', 'corporate']
      - name: age_group
        description: Age group category
        tests:
          - accepted_values:
              values: ['Under 25', '25-34', '35-44', '45-54', '55+', 'Unknown']
      - name: tenure_category
        description: Length of stay category
        tests:
          - accepted_values:
              values: ['Short (<6mo)', 'Medium (6-12mo)', 'Long (1-2yr)', 'Very Long (2yr+)', 'Unknown']
      - name: occupation_industry
        description: Industry/occupation type (業種)
      - name: moveout_reason_en
        description: Moveout reason (English)
  
  - name: moveout_summary
    description: |
      Pre-aggregated moveout summary for dashboard performance.
      Daily counts by rent range, prefecture, and tenant type with breakdowns by gender, age group, and tenure.
      Optimized for landscape analysis and reporting queries.
    config:
      schema: gold
    columns:
      - name: moveout_date
        description: Moveout date
        tests:
          - not_null
      - name: moveout_year_month
        description: Year-month string (YYYY-MM) for monthly aggregation
        tests:
          - not_null
      - name: rent_range
        description: Categorical rent range bucket
        tests:
          - not_null
          - accepted_values:
              values: ['Under 50K', '50K-70K', '70K-100K', '100K-150K', '150K+']
      - name: rent_range_order
        description: Sort order for rent ranges (1-5)
        tests:
          - not_null
      - name: prefecture
        description: Prefecture (都道府県)
      - name: tenant_type
        description: Tenant classification (individual/corporate)
        tests:
          - not_null
          - accepted_values:
              values: ['individual', 'corporate']
      - name: moveout_count
        description: Total number of moveouts for this dimension combination
        tests:
          - not_null
      - name: avg_monthly_rent
        description: Average monthly rent for moveouts in this group
      - name: avg_tenure_months
        description: Average length of stay in months
      - name: gender_male_count
        description: Count of male tenants in this group
      - name: gender_female_count
        description: Count of female tenants in this group
      - name: age_under_25_count
        description: Count of tenants under 25 years old
      - name: age_25_34_count
        description: Count of tenants aged 25-34
      - name: tenure_short_count
        description: Count of tenants with short stays (<6 months)
      - name: tenure_medium_count
        description: Count of tenants with medium stays (6-12 months)
      - name: tenure_long_count
        description: Count of tenants with long stays (1-2 years)
      - name: tenure_very_long_count
        description: Count of tenants with very long stays (2+ years)

  - name: occupancy_kpi_meta
    description: |
      Single-row meta table for occupancy KPI dashboards.
      Provides the semantic "as-of snapshot date" boundary for fact vs projection,
      plus freshness signals for gold.occupancy_daily_metrics.
    config:
      schema: gold
    columns:
      - name: as_of_snapshot_date
        description: MAX(snapshot_date) from silver.tenant_room_snapshot_daily
        tests:
          - not_null
      - name: lag_days
        description: Calendar lag in days (calendar_today - as_of_snapshot_date)
    tests:
      - dbt_utils.expression_is_true:
          expression: "lag_days >= 0"
          severity: warn

  - name: dim_property
    description: |
      Property dimension table with validated geolocation and basic room counts.
      Grain: 1 row per apartment_id.
    config:
      schema: gold
    columns:
      - name: apartment_id
        description: Apartment primary key
        tests:
          - unique
          - not_null
      - name: asset_id_hj
        description: Property identifier (AssetID_HJ)
        tests:
          - not_null
      - name: latitude
        description: Validated property latitude
        tests:
          - not_null
      - name: longitude
        description: Validated property longitude
        tests:
          - not_null
    tests:
      - dbt_utils.expression_is_true:
          expression: "latitude BETWEEN 35.0 AND 36.0 AND longitude BETWEEN 139.0 AND 140.5"
          severity: error

  - name: occupancy_property_daily
    description: |
      Daily property-level occupancy derived from silver.tenant_room_snapshot_daily.
      Grain: (snapshot_date, asset_id_hj).
    config:
      schema: gold
    columns:
      - name: snapshot_date
        description: Snapshot date
        tests:
          - not_null
      - name: asset_id_hj
        description: Property identifier (AssetID_HJ)
        tests:
          - not_null
      - name: occupancy_rate
        description: Occupancy rate at property level (occupied_rooms / total_rooms)
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['snapshot_date', 'asset_id_hj']
      - dbt_utils.expression_is_true:
          expression: "occupancy_rate >= 0 AND occupancy_rate <= 1"
          severity: error
      - dbt_utils.expression_is_true:
          expression: "occupied_rooms <= total_rooms"
          severity: warn

  - name: occupancy_property_map_latest
    description: |
      Latest-snapshot property occupancy table for mapping, including 7-day deltas.
      Grain: 1 row per asset_id_hj for the latest snapshot_date.
    config:
      schema: gold
    columns:
      - name: asset_id_hj
        description: Property identifier (AssetID_HJ)
        tests:
          - unique
          - not_null
      - name: latitude
        description: Property latitude
        tests:
          - not_null
      - name: longitude
        description: Property longitude
        tests:
          - not_null
    tests:
      - dbt_utils.expression_is_true:
          expression: "latitude BETWEEN 35.0 AND 36.0 AND longitude BETWEEN 139.0 AND 140.5"
          severity: error

  - name: movein_analysis
    description: |
      Enhanced move-in analysis table with categorical dimensions (rent ranges, age groups,
      lead-time buckets) for weekly-first move-in profiling.
      Grain: 1 row per contract_id.
    config:
      schema: gold
    columns:
      - name: contract_id
        description: Contract ID
        tests:
          - unique
          - not_null
      - name: tenant_type
        description: Tenant classification (individual/corporate)
        tests:
          - not_null
          - accepted_values:
              values: ['individual', 'corporate']
      - name: rent_range
        description: Categorical rent range bucket
        tests:
          - not_null
          - accepted_values:
              values: ['Under 50K', '50K-70K', '70K-100K', '100K-150K', '150K+']
      - name: age_group
        description: Age group category
        tests:
          - accepted_values:
              values: ['Under 25', '25-34', '35-44', '45-54', '55+', 'Unknown']

  - name: move_events
    description: |
      Unified move-in and move-out events at the contract grain.
      Provides week_start (Monday buckets) for weekly-first analysis.
      Grain: 1 row per (event_type, contract_id).
    config:
      schema: gold
    columns:
      - name: event_id
        description: Synthetic event id (event_type + contract_id)
        tests:
          - unique
          - not_null
      - name: event_type
        description: Event type (movein/moveout)
        tests:
          - not_null
          - accepted_values:
              values: ['movein', 'moveout']
      - name: week_start
        description: Monday-start week bucket for event_date
        tests:
          - not_null
      - name: latitude
        description: Property latitude
        tests:
          - not_null
      - name: longitude
        description: Property longitude
        tests:
          - not_null
    tests:
      - dbt_utils.expression_is_true:
          expression: "WEEKDAY(week_start) = 0"
          severity: error

  - name: move_events_weekly
    description: |
      Weekly aggregated cube of move events for dashboards.
      Grain: (week_start, event_type, tenant_type, rent_range, age_group).
    config:
      schema: gold
    columns:
      - name: week_start
        tests:
          - not_null
      - name: event_count
        description: Weekly event count
        tests:
          - not_null
    tests:
      - dbt_utils.expression_is_true:
          expression: "event_count >= 0"
          severity: error

  - name: municipality_churn_weekly
    description: Weekly net change (move-ins - move-outs) by municipality.
    config:
      schema: gold
    columns:
      - name: week_start
        tests:
          - not_null
      - name: municipality
        tests:
          - not_null
      - name: movein_count
        description: Weekly move-in count for this municipality
        tests:
          - not_null
      - name: moveout_count
        description: Weekly move-out count for this municipality
        tests:
          - not_null
      - name: net_change
        description: Move-ins minus move-outs (can be negative)
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['week_start', 'municipality']
      - dbt_utils.expression_is_true:
          expression: "movein_count >= 0 AND moveout_count >= 0"
          severity: error
      - dbt_utils.expression_is_true:
          expression: "net_change = movein_count - moveout_count"
          severity: error

  - name: property_churn_weekly
    description: Weekly net change (move-ins - move-outs) by property.
    config:
      schema: gold
    columns:
      - name: week_start
        tests:
          - not_null
      - name: asset_id_hj
        tests:
          - not_null
      - name: movein_count
        description: Weekly move-in count for this property
        tests:
          - not_null
      - name: moveout_count
        description: Weekly move-out count for this property
        tests:
          - not_null
      - name: net_change
        description: Move-ins minus move-outs (can be negative)
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['week_start', 'asset_id_hj']
      - dbt_utils.expression_is_true:
          expression: "movein_count >= 0 AND moveout_count >= 0"
          severity: error
      - dbt_utils.expression_is_true:
          expression: "net_change = movein_count - moveout_count"
          severity: error

  - name: moveouts_reason_weekly
    description: Weekly move-out counts by reason (and basic segments).
    config:
      schema: gold
    columns:
      - name: week_start
        tests:
          - not_null
      - name: moveout_reason_en
        tests:
          - not_null
      - name: tenant_type
        tests:
          - not_null
          - accepted_values:
              values: ['individual', 'corporate']
      - name: moveout_count
        description: Weekly move-out count for this dimension combination
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['week_start', 'moveout_reason_en', 'tenant_type', 'rent_range']
      - dbt_utils.expression_is_true:
          expression: "moveout_count >= 0"
          severity: error
