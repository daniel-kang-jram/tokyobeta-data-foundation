version: 2

models:
  - name: occupancy_daily_metrics
    description: |
      Daily occupancy KPI metrics computed from silver.tenant_room_snapshot_daily.
      Updated incrementally by Glue (not dbt) for target dates only.
      
      Grain: One row per snapshot_date.
      Volume: 1 row/day (365 rows/year).
      
      Metrics:
      - 申込 (applications): First appearance of pairs in status 4 or 5
      - 新規入居者 (new_moveins): Pairs with move_in_date = snapshot_date
      - 新規退去者 (new_moveouts): Pairs with moveout date = snapshot_date (past: moveout_plans_date, future: moveout_date)
      - 稼働室数増減 (occupancy_delta): new_moveins - new_moveouts
      - 期首稼働室数 (period_start_rooms): Occupied count on previous day
      - 期末稼働室数 (period_end_rooms): period_start + delta
      - 稼働率 (occupancy_rate): period_end / 16108
    
    config:
      schema: gold
    
    columns:
      - name: snapshot_date
        description: Snapshot date
        tests:
          - unique
          - not_null
      
      - name: applications
        description: Number of first-time applications (status 4 or 5)
        tests:
          - not_null
      
      - name: new_moveins
        description: Number of new move-ins on this date
        tests:
          - not_null
      
      - name: new_moveouts
        description: Number of new move-outs on this date
        tests:
          - not_null
      
      - name: occupancy_delta
        description: Net change in occupied rooms (moveins - moveouts)
        tests:
          - not_null
      
      - name: period_start_rooms
        description: Occupied rooms at start of day (previous day's end count)
        tests:
          - not_null
      
      - name: period_end_rooms
        description: Occupied rooms at end of day
        tests:
          - not_null
      
      - name: occupancy_rate
        description: Occupancy rate (period_end_rooms / 16108)
        tests:
          - not_null
    
    tests:
      # Arithmetic invariant: period_end = period_start + delta
      - dbt_utils.expression_is_true:
          expression: "period_end_rooms = period_start_rooms + occupancy_delta"
          severity: error
      
      # Arithmetic invariant: delta = moveins - moveouts
      - dbt_utils.expression_is_true:
          expression: "occupancy_delta = new_moveins - new_moveouts"
          severity: error
      
      # Rate calculation: occupancy_rate = period_end / 16108
      - dbt_utils.expression_is_true:
          expression: "ABS(occupancy_rate - (period_end_rooms / 16108.0)) < 0.0001"
          severity: error

  - name: tenant_status_transitions
    description: |
      Analysis-ready view of tenant status changes over time with business-friendly labels.
      Tracks status transitions, payment changes, and renewal eligibility over time.
      Includes duration calculations and transition flow analysis.
    columns:
      - name: tenant_id
        description: Tenant identifier
        tests:
          - not_null
      - name: effective_date
        description: Date when this status became effective
        tests:
          - not_null
      - name: end_date
        description: Date when this status ended (NULL if current)
      - name: is_current
        description: Boolean flag for current/active status
      - name: status_code
        description: Numeric tenant status code
      - name: status_label
        description: Human-readable status description
      - name: previous_status_code
        description: Previous status code (for transition analysis)
      - name: previous_status_label
        description: Previous status human-readable label
      - name: status_changed
        description: Boolean flag indicating if status changed from previous record
      - name: status_transition
        description: Formatted string showing status transition (e.g., "Inquiry → Active Tenant")
      - name: contract_type_label
        description: Human-readable contract type (Individual/Corporate)
      - name: is_unpaid
        description: Boolean flag for unpaid Paysle charges
      - name: payment_status_changed
        description: Boolean flag indicating payment status changed
      - name: payment_status_change
        description: Formatted payment status change description
      - name: days_in_status
        description: Number of days tenant has been in current status
  
  - name: new_contracts
    description: New contract records with full demographics and geolocation
    config:
      schema: gold
    columns:
      - name: contract_id
        description: Contract ID
        tests:
          - unique
          - not_null
      - name: asset_id_hj
        description: Property ID
        tests:
          - not_null
      - name: contract_date
        description: Contract signing date
        tests:
          - not_null
      - name: latitude
        description: Property latitude
        tests:
          - not_null
      - name: longitude
        description: Property longitude
        tests:
          - not_null
  
  - name: moveouts
    description: Completed moveout records with full contract history
    config:
      schema: gold
    columns:
      - name: contract_id
        description: Contract ID
        tests:
          - unique
          - not_null
      - name: asset_id_hj
        description: Property ID
        tests:
          - not_null
      - name: moveout_date
        description: Moveout date
        tests:
          - not_null
      - name: latitude
        description: Property latitude
        tests:
          - not_null
      - name: longitude
        description: Property longitude
        tests:
          - not_null
  
  - name: moveout_notices
    description: Moveout notices with 24-month rolling window
    config:
      schema: gold
    columns:
      - name: contract_id
        description: Contract ID
        tests:
          - unique
          - not_null
      - name: asset_id_hj
        description: Property ID
        tests:
          - not_null
      - name: notice_received_date
        description: Date moveout notice was received
        tests:
          - not_null
  
  - name: moveout_analysis
    description: |
      Enhanced moveout analysis table with categorical dimensions for demographic and financial analysis.
      Includes rent range bucketing, age groups, tenure categories, and all demographic markers.
      Optimized for drill-down analysis and filtering by multiple dimensions.
    config:
      schema: gold
    columns:
      - name: contract_id
        description: Contract ID
        tests:
          - unique
          - not_null
      - name: asset_id_hj
        description: Property ID (AssetID_HJ)
        tests:
          - not_null
      - name: moveout_date
        description: Moveout date (退去日)
        tests:
          - not_null
      - name: rent_range
        description: Categorical rent range bucket
        tests:
          - not_null
          - accepted_values:
              values: ['Under 50K', '50K-70K', '70K-100K', '100K-150K', '150K+']
      - name: rent_range_order
        description: Sort order for rent ranges (1-5)
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5]
      - name: monthly_rent
        description: Monthly rent amount (月額賃料)
        tests:
          - not_null
      - name: prefecture
        description: Prefecture (都道府県)
      - name: municipality
        description: Municipality (市区町村)
      - name: latitude
        description: Property latitude
        tests:
          - not_null
      - name: longitude
        description: Property longitude
        tests:
          - not_null
      - name: tenant_type
        description: Tenant classification (individual/corporate)
        tests:
          - not_null
          - accepted_values:
              values: ['individual', 'corporate']
      - name: age_group
        description: Age group category
        tests:
          - accepted_values:
              values: ['Under 25', '25-34', '35-44', '45-54', '55+', 'Unknown']
      - name: tenure_category
        description: Length of stay category
        tests:
          - accepted_values:
              values: ['Short (<6mo)', 'Medium (6-12mo)', 'Long (1-2yr)', 'Very Long (2yr+)', 'Unknown']
      - name: occupation_industry
        description: Industry/occupation type (業種)
      - name: moveout_reason_en
        description: Moveout reason (English)
  
  - name: moveout_summary
    description: |
      Pre-aggregated moveout summary for dashboard performance.
      Daily counts by rent range, prefecture, and tenant type with breakdowns by gender, age group, and tenure.
      Optimized for landscape analysis and reporting queries.
    config:
      schema: gold
    columns:
      - name: moveout_date
        description: Moveout date
        tests:
          - not_null
      - name: moveout_year_month
        description: Year-month string (YYYY-MM) for monthly aggregation
        tests:
          - not_null
      - name: rent_range
        description: Categorical rent range bucket
        tests:
          - not_null
          - accepted_values:
              values: ['Under 50K', '50K-70K', '70K-100K', '100K-150K', '150K+']
      - name: rent_range_order
        description: Sort order for rent ranges (1-5)
        tests:
          - not_null
      - name: prefecture
        description: Prefecture (都道府県)
      - name: tenant_type
        description: Tenant classification (individual/corporate)
        tests:
          - not_null
          - accepted_values:
              values: ['individual', 'corporate']
      - name: moveout_count
        description: Total number of moveouts for this dimension combination
        tests:
          - not_null
      - name: avg_monthly_rent
        description: Average monthly rent for moveouts in this group
      - name: avg_tenure_months
        description: Average length of stay in months
      - name: gender_male_count
        description: Count of male tenants in this group
      - name: gender_female_count
        description: Count of female tenants in this group
      - name: age_under_25_count
        description: Count of tenants under 25 years old
      - name: age_25_34_count
        description: Count of tenants aged 25-34
      - name: tenure_short_count
        description: Count of tenants with short stays (<6 months)
      - name: tenure_medium_count
        description: Count of tenants with medium stays (6-12 months)
      - name: tenure_long_count
        description: Count of tenants with long stays (1-2 years)
      - name: tenure_very_long_count
        description: Count of tenants with very long stays (2+ years)