version: 2

models:
  - name: tenant_status_history
    description: |
      Slowly Changing Dimension (SCD Type 2) tracking historical changes in tenant status.
      
      **WIPE-RESILIENT DESIGN:**
      - Built from staging.tenant_daily_snapshots (loaded from S3 daily)
      - Fully rebuilt on each run (materialized='table')
      - S3 is the source of truth - Aurora wipes don't lose history
      - Historical data back to May 2025 (260+ days of snapshots)
      
      Uses LAG() window functions over daily snapshots to detect when status changed,
      then creates SCD Type 2 records with valid_from/valid_to date ranges.
      
      **DATA NOTES:**
      - ~46% of rows have full_name='*' (from early dumps May-June 2025 where names were masked)
      - valid_from = The dump date where this status first appeared (this is your "dump file date")
      - valid_to = Day before status changed (NULL if still current)
    columns:
      - name: tenant_id
        description: Tenant identifier
        tests:
          - not_null
      - name: full_name
        description: |
          Tenant full name (姓名). Note: '*' indicates masked/redacted names from early dumps (May-June 2025)
      - name: status
        description: Tenant status code (0-17)
        tests:
          - not_null
      - name: status_label_ja
        description: Japanese label for status (e.g., 入居中, 退去済み)
      - name: status_label_en
        description: English label for status (e.g., Active Tenant, Moved Out)
      - name: is_active_lease
        description: Flag indicating tenant has active lease (status 7,9,10,13)
      - name: contract_type
        description: Contract type code (1=一般, 2=法人契約, 3=法人契約個人, etc.)
        tests:
          - not_null
      - name: tenant_type
        description: |
          Classification: 'individual', 'corporate', or 'unknown'
          Based on contract_type (2,3=corporate, 1,6,7,9=individual)
      - name: contract_type_label_ja
        description: Japanese label for contract type (e.g., 一般, 法人契約)
      - name: valid_from
        description: |
          **Start date of this status period** (inclusive).
          This is the dump file date where this status first appeared.
          Use this column to know which day's snapshot each row represents.
        tests:
          - not_null
      - name: valid_to
        description: |
          **End date of this status period** (inclusive), NULL if current.
          This is the day before status changed to something else.
      - name: is_current
        description: Boolean flag indicating if this is the current/latest status for this tenant
        tests:
          - not_null
      - name: days_in_status
        description: Number of days in this status (calculated from valid_from to valid_to or today)
      - name: dbt_updated_at
        description: Timestamp when this record was created/updated by dbt
  - name: stg_movings
    description: Cleaned contract lifecycle data with semantic code labels
    config:
      schema: silver
    columns:
      - name: moving_id
        description: Primary key - contract/moving ID
        tests:
          # unique test disabled - too slow on 25k+ rows (full table scan)
          # Enforced by MySQL PRIMARY KEY constraint instead
          - not_null
      - name: tenant_id
        description: Foreign key to tenants
        tests:
          - not_null
      - name: apartment_id
        description: Foreign key to apartments
        tests:
          - not_null
      - name: room_id
        description: Foreign key to rooms
        tests:
          - not_null
      - name: tenant_type
        description: Individual or corporate classification
        tests:
          - accepted_values:
              values: ['individual', 'corporate']
      - name: is_valid_contract
        description: Contract is active and not cancelled
      - name: is_completed_moveout
        description: Moveout has been completed
  
  - name: stg_tenants
    description: Cleaned tenant demographics with semantic labels
    config:
      schema: silver
    columns:
      - name: tenant_id
        description: Primary key - tenant ID
        tests:
          # unique test disabled - too slow on 12k+ rows (full table scan)
          # Enforced by MySQL PRIMARY KEY constraint instead
          - not_null
      - name: gender
        description: Gender label (English)
      - name: age
        description: Current age (calculated from birth_date if available)
      - name: nationality
        description: Nationality name
      - name: tenant_status_en
        description: Current tenant status (English label)
      - name: is_active_lease
        description: Flag indicating tenant has active lease (status 7,9,10,13)
  
  - name: stg_apartments
    description: Cleaned property data with validated geolocation
    config:
      schema: silver
    columns:
      - name: apartment_id
        description: Primary key - apartment ID
        tests:
          # unique test disabled for consistency (even though only 700 rows)
          # Enforced by MySQL PRIMARY KEY constraint instead
          - not_null
      - name: asset_id_hj
        description: Property ID from GUI system (AssetID_HJ)
        tests:
          - not_null
      - name: apartment_name
        description: Property name (Japanese)
        tests:
          - not_null
      - name: prefecture
        description: Prefecture
        tests:
          - not_null
      - name: latitude
        description: Validated latitude (Tokyo bounds 35.0-36.0)
      - name: longitude
        description: Validated longitude (Tokyo bounds 139.0-140.5)
  
  - name: stg_rooms
    description: Cleaned room data
    config:
      schema: silver
    columns:
      - name: room_id
        description: Primary key - room ID
        tests:
          # unique test disabled - too slow on 16k+ rows (full table scan)
          # Enforced by MySQL PRIMARY KEY constraint instead
          - not_null
      - name: apartment_id
        description: Foreign key to apartments
        tests:
          - not_null
      - name: room_number
        description: Room number
  
  - name: int_contracts
    description: Denormalized contract fact table - single source of truth for all analytics
    config:
      schema: silver
    columns:
      - name: contract_id
        description: Primary key - contract ID
        tests:
          # unique test disabled - too slow on 17k+ rows (full table scan)
          # Enforced by MySQL PRIMARY KEY constraint instead
          - not_null
      - name: asset_id_hj
        description: Property ID (AssetID_HJ)
        tests:
          - not_null
      - name: tenant_type
        description: Individual or corporate classification
        tests:
          - accepted_values:
              values: ['individual', 'corporate']
      - name: latitude
        description: Property latitude
      - name: longitude
        description: Property longitude
      - name: contract_date
        description: Contract signing date (契約締結日)
      - name: moveout_date
        description: Integrated moveout date (退去日)
