version: 2

models:
  - name: tenant_room_snapshot_daily
    description: |
      Daily incremental snapshot of active tenant-room pairs for occupancy tracking.
      
      Grain: One row per (snapshot_date, tenant_id, apartment_id, room_id).
      Materialization: Incremental (append-only by snapshot_date).
      Retention: 12 months in Aurora, older archived to S3.
      
      Volume: ~12,000 rows/day (~4.4M rows/year).
      
      Deduplication layers:
        1. rn=1 per (tenant_id, apartment_id, room_id): removes ~3,500 duplicate
           corporate contract records left open in staging.movings.
        2. is_room_primary=TRUE per (apartment_id, room_id): marks one authoritative
           tenant per physical room. Rooms in turnover (outgoing + incoming tenant
           simultaneously registered) retain both rows; only the current occupant
           is flagged TRUE. Use this for physical-room occupancy counting.
      
      Used by:
      - gold.occupancy_daily_metrics (KPI computation)
      - Analysis queries requiring tenant-level daily history
      
      **DATA QUALITY:**
      - dbt tests disabled (too slow on 1.5M+ rows, taking 5+ minutes)
      - Constraints validated by incremental date gating + downstream sanity checks
      - Verified during backfill and spot-checked via SQL queries
    
    config:
      materialized: incremental
      incremental_strategy: append
    
    columns:
      - name: snapshot_date
        description: Date of snapshot
      
      - name: tenant_id
        description: Tenant ID
      
      - name: apartment_id
        description: Apartment/property ID
      
      - name: room_id
        description: Room ID
      
      - name: management_status_code
        description: Tenant status code (numeric)
      
      - name: management_status
        description: Tenant status (Japanese label)
      
      - name: tenant_name
        description: Tenant full name
      
      - name: property
        description: Apartment/building name
      
      - name: room_number
        description: Room number
      
      - name: contract_category
        description: Contract type category
      
      - name: move_in_date
        description: Move-in date
      
      - name: moveout_date
        description: Planned/scheduled moveout date (forecast)
      
      - name: moveout_plans_date
        description: Actual moveout date (past only)
      
      - name: is_room_primary
        description: |
          TRUE for at most one row per (snapshot_date, apartment_id, room_id),
          and only when the top-priority tenant is physically present (status IN
          7, 9, 10, 11, 12, 13, 14, 15).

          Rooms with only pre-move-in tenants (仮予約=4, 初回家賃入金=5, 入居説明=6)
          get FALSE on all rows — the room is reserved but not yet occupied.

          Use WHERE is_room_primary = TRUE to count physically occupied rooms
          per the business rule "その日に入居していれば1、入居していなければ0".
      
      - name: moving_id
        description: Moving record ID
      
      - name: dbt_updated_at
        description: Timestamp when dbt last updated this row
