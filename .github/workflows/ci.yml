name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  glue-tests:
    name: Glue Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r glue/tests/requirements.txt
      - name: Run Glue unit tests
        run: |
          # Coverage floor reflects existing glue test scope; full 80% gate is not yet achievable
          # without broadening coverage across remaining low-coverage scripts.
          pytest glue/tests -q --cov=glue/scripts --cov-report=term-missing --cov-fail-under=45
      - name: Run pipeline integration checks
        run: |
          python3 scripts/tests/test_etl_integration.py

  terraform-check:
    name: Terraform Validate
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Build freshness checker PyMySQL layer artifact
        run: |
          set -euo pipefail
          rm -f terraform/modules/monitoring/pymysql_layer.zip
          layer_build_dir="$(mktemp -d)"
          python -m pip install --upgrade pip
          python -m pip install --target "${layer_build_dir}/python" "pymysql==1.1.1"
          (
            cd "${layer_build_dir}"
            zip -qr "${GITHUB_WORKSPACE}/terraform/modules/monitoring/pymysql_layer.zip" python
          )
          if [[ ! -s terraform/modules/monitoring/pymysql_layer.zip ]]; then
            echo "::error::Failed to build terraform/modules/monitoring/pymysql_layer.zip."
            exit 1
          fi
      - name: Enforce required production CIDRs
        run: |
          required_cidrs=("13.112.83.65/32" "54.168.114.197/32")
          for cidr in "${required_cidrs[@]}"; do
            if ! grep -q "${cidr}" terraform/environments/prod/variables.tf; then
              echo "::error::terraform/environments/prod/variables.tf must include ${cidr}."
              exit 1
            fi
            if ! grep -q "${cidr}" .github/workflows/deploy-prod.yml; then
              echo "::error::.github/workflows/deploy-prod.yml must include ${cidr}."
              exit 1
            fi
          done
      - name: Enforce prod dump-secret isolation guard
        run: |
          if ! grep -q 'variable "create_rds_cron_secret"' terraform/environments/prod/variables.tf; then
            echo "::error::terraform/environments/prod/variables.tf must declare create_rds_cron_secret."
            exit 1
          fi
          create_var_block="$(awk '/variable "create_rds_cron_secret"/,/^}/' terraform/environments/prod/variables.tf)"
          if [[ "${create_var_block}" != *'default     = true'* ]]; then
            echo "::error::terraform/environments/prod/variables.tf must default create_rds_cron_secret=true."
            exit 1
          fi
          if ! grep -q 'variable "manage_rds_cron_secret_value"' terraform/environments/prod/variables.tf; then
            echo "::error::terraform/environments/prod/variables.tf must declare manage_rds_cron_secret_value."
            exit 1
          fi
          var_block="$(awk '/variable "manage_rds_cron_secret_value"/,/^}/' terraform/environments/prod/variables.tf)"
          if [[ "${var_block}" != *'default     = false'* ]]; then
            echo "::error::terraform/environments/prod/variables.tf must default manage_rds_cron_secret_value=false."
            exit 1
          fi
          if ! grep -q 'TF_VAR_manage_rds_cron_secret_value: "false"' .github/workflows/deploy-prod.yml; then
            echo "::error::.github/workflows/deploy-prod.yml must enforce TF_VAR_manage_rds_cron_secret_value=\"false\"."
            exit 1
          fi
          if ! grep -q 'TF_VAR_create_rds_cron_secret: "true"' .github/workflows/deploy-prod.yml; then
            echo "::error::.github/workflows/deploy-prod.yml must enforce TF_VAR_create_rds_cron_secret=\"true\"."
            exit 1
          fi
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5
      - name: Terraform fmt
        run: terraform fmt -check -recursive terraform/environments
      - name: Validate prod Terraform
        working-directory: terraform/environments/prod
        run: |
          terraform init -backend=false
          terraform validate
      - name: Validate test EC2 role Terraform
        working-directory: terraform/environments/test_ec2_role
        run: |
          terraform init -backend=false
          terraform validate

  evidence-build:
    name: Evidence Build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect Evidence changes
        id: evidence_changes
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi

          if [[ -z "$BASE_SHA" || -z "$HEAD_SHA" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          WATCH_PATHS=(
            "evidence/"
            "scripts/evidence/"
            "scripts/tests/"
            ".github/workflows/"
            "evidence/buildspec.yml"
          )

          CHANGED=false
          while IFS= read -r changed_file; do
            [[ -z "$changed_file" ]] && continue
            for watch_path in "${WATCH_PATHS[@]}"; do
              if [[ "$changed_file" == "$watch_path"* ]]; then
                CHANGED=true
                break 2
              fi
            done
          done < <(git diff --name-only "$BASE_SHA" "$HEAD_SHA")

          echo "changed=${CHANGED}" >> "$GITHUB_OUTPUT"
      - name: Skip if no Evidence changes
        if: steps.evidence_changes.outputs.changed != 'true'
        run: echo "No Evidence path changes detected. Skipping."
      - name: Set up Node
        if: steps.evidence_changes.outputs.changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version-file: evidence/.nvmrc
      - name: Set up Python
        if: steps.evidence_changes.outputs.changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Evidence dependencies
        if: steps.evidence_changes.outputs.changed == 'true'
        run: |
          cd evidence
          npm ci
      - name: Build Evidence
        if: steps.evidence_changes.outputs.changed == 'true'
        run: |
          cd evidence
          npm run build
      - name: Verify Evidence route contract
        if: steps.evidence_changes.outputs.changed == 'true'
        run: |
          node scripts/evidence/verify_route_contract.mjs --build-dir evidence/build --routes occupancy moveins moveouts geography pricing
      - name: Run Evidence release guardrail tests
        if: steps.evidence_changes.outputs.changed == 'true'
        run: |
          python3 -m pytest scripts/tests/test_evidence_auth_asset_guard.py scripts/tests/test_evidence_release_guardrails.py -q
          python3 -m pytest scripts/tests/test_evidence_authenticated_smoke_contract.py -q
